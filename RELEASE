How to release:

## Pre-Release Verification

Before starting the release, run the verification script to catch common issues:

```bash
./verify-release-ready.sh
```

This checks:
- Java 8 is active
- Git working directory is clean
- On master branch
- Maven settings configured
- Javadoc builds without errors
- SCM URLs match git remote
- Tests pass
- GPG key is available
- Bytecode version is Java 8

If you have a custom SSH alias for GitHub (like `github.com-spotify`), configure git URL rewriting:

```bash
git config --local url."git@github.com-spotify:".insteadOf "git@github.com:"
```

## Maven Settings

**IMPORTANT**: Sonatype has migrated from legacy OSSRH (oss.sonatype.org) to the
Central Publishing Portal (central.sonatype.com). You need a user token, not a password.

### Get User Token

1. Go to https://central.sonatype.com/account
2. Generate or view your user token
3. Add the token to ~/.m2/settings.xml:

```xml
<settings>
  <servers>
    <server>
      <id>central</id>
      <username>YOUR_TOKEN_USERNAME</username>
      <password>YOUR_TOKEN_PASSWORD</password>
    </server>
  </servers>
</settings>
```

Optional (for GPG passphrase):
```xml
<profiles>
  <profile>
    <id>gpg</id>
    <activation>
      <activeByDefault>true</activeByDefault>
    </activation>
    <properties>
      <gpg.executable>gpg</gpg.executable>
      <gpg.passphrase>YOUR_GPG_PASSPHRASE</gpg.passphrase>
    </properties>
  </profile>
</profiles>
```

## Release Process

```bash
# 1. Run pre-release verification
./verify-release-ready.sh

# 2. Execute release (both prepare and perform can be run together)
mvn -B release:prepare release:perform -Darguments="-DskipTests=true"

# Note: Tests are skipped during release since they were already verified in step 1
```

**What happens during release:**
- `release:prepare` - Creates release tag, bumps version, commits to git, pushes to GitHub
- `release:perform` - Builds artifacts, signs with GPG, uploads to Maven Central, auto-publishes

**Important notes:**
- The `-Psonatype-oss-release` profile is NO longer needed with Central Publishing Portal
- Artifacts are automatically published (no manual staging/closing required)
- Release takes ~1 minute total

## Post-Release Verification

After release completes successfully:

```bash
# Quick verification
git fetch --tags
git tag | grep sparkey-X.X.X
grep "<version>" pom.xml | head -1  # Should show X.X.X+1-SNAPSHOT
```

**Check deployment status:**
https://central.sonatype.com/publishing/deployments

**Full post-release checklist:**
See [POST-RELEASE-CHECKLIST.md](POST-RELEASE-CHECKLIST.md) for complete verification steps.

**Create GitHub release (optional):**
```bash
gh release create sparkey-X.X.X --title "Version X.X.X" --notes "See CHANGELOG.md"
```

## Troubleshooting Failed Releases

If the release fails partway through:

```bash
# Run cleanup script
./cleanup-failed-release.sh

# Review what went wrong
# Fix the issue (update pom.xml, fix tests, etc.)

# Re-run verification
./verify-release-ready.sh

# Retry release
mvn -B release:prepare release:perform -Darguments="-DskipTests=true"
```

Common issues and solutions documented in [POST-RELEASE-CHECKLIST.md](POST-RELEASE-CHECKLIST.md#troubleshooting)

